#+title: Doom Emacs Configuration
#+author: Jorge Vargas Silva.
#+description: A literate programming approach to my Doom Emacs configuration

* Introduction
I started using Emacs a while ago, mainly because of org-mode.
Org-mode is an amazing tool, but it needs some work to be as I want. This is my attempt to create a literate config for it.
I'm trying to take advantage of LP while transitioning from Spacemacs to doom Emacs.

* Base Doom Configuration
** Core Settings
These are the fundamental settings that Doom Emacs needs to function as I prefer.
Some of these must be set before packages load.

#+BEGIN_SRC emacs-lisp
(setq gc-cons-threshold 100000000);;
(setq read-process-output-max (* 10 1024 1024))  ; 10MB, helps large JSON

(require 'acp)
(require 'agent-shell)

;;; config.el -*- lexical-binding: t; -*-

;; Font Configuration
;; Doom provides five font variables you can adjust:
;; - doom-font: The primary monospace font
;; - doom-variable-pitch-font: Non-monospace font for variable-pitch-mode
;; - doom-big-font: Used for doom-big-font-mode (presentations/streaming)
;; - doom-symbol-font: Font for symbols
;; - doom-serif-font: Font for the fixed-pitch-serif face
(setq doom-font (font-spec :family "MesloLGSDZ Nerd Font" :size 14 :weight 'normal))
(setq doom-variable-pitch-font (font-spec :family "MesloLGSDZ Nerd Font" :size 14 :weight 'normal))

;; Theme Configuration
;; Load one of Doom's gorgeous themes
;; (setq doom-theme 'doom-acario-dark)
;; I use solaire-mode to make the active buffer stand out
;; Awesome tool tbh, didn't knew that it would be THAT useful.
(solaire-global-mode +1)

;; Line Numbers
;; Options: t (absolute), 'relative, or nil (disabled)
(setq display-line-numbers-type 'relative)

;; Org Directory
;; Must be sEt before org loads!
(setq org-directory "~/orgfiles/")

;; Enable `variable-pitch-mode` in all buffers
(setq doom-font doom-variable-pitch-font)

(remove-hook 'doom-first-input-hook #'evil-snipe-mode)

;; enable word-wrap (almost) everywhere
(+global-word-wrap-mode +1)
#+END_SRC

** Important Notes About Doom Configuration
Here are some key points to remember when configuring Doom Emacs:

1. Most configurations should be wrapped in ~after!~ blocks to ensure they load
   after Doom's defaults. This prevents Doom from accidentally overriding your settings.

2. Exceptions to the ~after!~ rule:
   - File/directory variables (like ~org-directory~)
   - Variables that must be set before package loading
   - Doom-specific variables (prefixed with 'doom-' or '+')

3. Useful configuration helpers:
   - ~load!~ :: For loading external .el files
   - ~use-package!~ :: For configuring packages
   - ~after!~ :: For running code after a package loads
   - ~add-load-path!~ :: For adding directories to the ~load-path~
   - ~map!~ :: For binding new keys

4. Getting help:
   - Press 'K' over a symbol for documentation
   - Use 'C-h o' to look up symbols
   - Try 'gd' to jump to definitions

* Org Configuration

** Folder configurations
Setting up the directory structure for all org files.

#+BEGIN_SRC emacs-lisp
(after! org
  (setq org-agenda-files (list (concat org-directory "/agenda.org"))
        org-default-notes-file (concat org-directory "/notes.org")
        org-refile-targets '((org-agenda-files :maxlevel . 3))
        org-todos-file (concat org-directory "/todos.org")
        org-notes-file (concat org-directory "/notes.org")
        org-journal-file (concat org-directory "/journal.org")
        org-journal-dir (concat org-directory "/journal/")))
#+END_SRC

** Core configurations
These are the basic configurations that control how org-mode behaves, including timestamps, logging, and visual preferences.

#+BEGIN_SRC emacs-lisp
(after! org
  ;; Load additional exporters
  (require 'ox-gfm nil t)
  ;; (require 'ox-md)

  ;; I like to have an explanation when i move things to ~done~, ~canceled~, ~next~ and ~waiting~.
  (setq org-todo-keywords
        '((sequence "TODO(t!)" "WAITING(w@/!)" "NEXT(n@/!)" "|" "DONE(d@/!)" "CANCELLED(c@/!)")))

  ;; Timestamp and logging configurations
  (setq org-log-done 'time
        org-log-redeadline 'time
        org-log-reschedule 'time
        org-log-into-drawer t

        ;; Behavior configurations
        org-return-follows-link t
        org-startup-indented t

        ;; Source block configurations
        org-src-fontify-natively t
        org-src-tab-acts-natively t
        org-src-preserve-indentation t)

  ;; These templates define quick capture patterns for todos, notes, and journal entries.
  (setq org-capture-templates
        `(("t" "Todo" entry (file+headline ,org-todos-file "Tasks")
           "* TODO %?\n  %U\n  %a")
          ("n" "Notes" entry (file+headline ,org-notes-file "Notes")
           "* %?\n  %U\n  %a")
          ("j" "Journal" entry (file+datetree ,org-journal-file)
           "* %?\nEntered on %U\n  %i\n  %a"))))
#+END_SRC

** Org-Download

#+begin_src emacs-lisp
(after! org-download
  (setq org-download-method 'directory)

  (defun jv/org-download-image-dir ()
    (concat (file-name-sans-extension (buffer-file-name)) "-images"))
  (setq org-download-image-dir #'jv/org-download-image-dir)

  ;; Relative links[[file:...]]
  (setq org-download-link-format "[[file:%s]]\n"
        org-download-abbreviate-filename-function #'file-relative-name)

  ;; Previsualizer width
  (setq org-download-image-org-width 600)
  (setq-default org-download-heading-lvl nil))
#+end_src
* Agenda
** Look all ORG_DIR for TODOs
I know that i'm messy, so search everywhere to prevent forgetting.

#+BEGIN_SRC emacs-lisp
(after! org
  (setq org-agenda-files (directory-files-recursively "~/orgfiles/" "\\.org$")))
#+END_SRC

* Babel
** Languages and configurations
Setting up org-babel for various programming languages and their configurations.

#+BEGIN_SRC emacs-lisp
(after! ob
  ;; Configure available languages
  ;; Doom doc's says this is not required here:
  ;; https://github.com/doomemacs/doomemacs/blob/master/docs/getting_started.org#using-org-babel-do-load-languages-to-load-your-babel-packages
  ;; (org-babel-do-load-languages
  ;;  'org-babel-load-languages
  ;;  '((shell      . t)
  ;;    (js         . t)
  ;;    (emacs-lisp . t)
  ;;    (elixir     . t)
  ;;    (python     . t)
  ;;    (ruby       . t)
  ;;    (css        . t)
  ;;    (R          . t)
  ;;    (sql        . t)
  ;;    (sqlite     . t)
  ;;    (org        . t)
  ;;    (sed        . t)
  ;;    (csharp     . t)
  ;;    (java       . t)))

  ;; Interpreter settings
  (setq org-babel-python-command "python3 -u"
        org-confirm-babel-evaluate nil))
#+END_SRC

* Github Copilot

I'm experimenting with Copilot. Not so good yet but i will keep trying:

#+BEGIN_SRC emacs-lisp
(use-package! copilot
  :hook (prog-mode . copilot-mode)
  :bind (:map copilot-completion-map
              ("<tab>" . 'copilot-accept-completion)
              ("TAB" . 'copilot-accept-completion)
              ("C-TAB" . 'copilot-accept-completion-by-word)
              ("C-<tab>" . 'copilot-accept-completion-by-word)
              ("C-n" . 'copilot-next-completion)
              ("C-p" . 'copilot-previous-completion))
  :config
  (setq copilot-max-char 1000000)
  ;; Ensure Copilot uses completion-at-point (capf), which corfu understands
  (add-to-list 'completion-at-point-functions #'copilot-completion-at-point)
  ;; Optional: Control when Copilot tries to complete
  ;; For example, only enable Copilot in insert mode if you use Evil:
  (setq copilot-enable-predicates '(evil-insert-state-p))

  ;; Configure indent config per language
  (add-to-list 'copilot-indentation-alist '(prog-mode 2))
  (add-to-list 'copilot-indentation-alist '(org-mode 2))
  (add-to-list 'copilot-indentation-alist '(text-mode 2))
  (add-to-list 'copilot-indentation-alist '(closure-mode 2))
  (add-to-list 'copilot-indentation-alist '(emacs-lisp-mode 2))

  ;; Override lang detection
  (add-to-list 'copilot-major-mode-alist '("enh-ruby" . "ruby"))
)
#+END_SRC

* LSPs

#+BEGIN_SRC emacs-lisp
(after! eglot
  ;; Elixir LSP
  (add-to-list 'eglot-server-programs
               `(elixir-mode . ,(eglot-alternatives
                               '(("nextls" "--stdio")
                                 ("~/code/elixir-ls/language_server.sh")))))
  ;; This is optional. It automatically runs `M-x eglot` for you whenever you are in `elixir-mode`:
  (add-hook 'elixir-mode-hook 'eglot-ensure)

  ;; Avoid symlinks crash
  ;; (setq find-file-visit-truename t)

  ;; Ruby LSP
  (add-to-list 'eglot-server-programs '((ruby-mode ruby-ts-mode) "ruby-lsp"))

  ;; Markdown AI (?)
  (add-to-list 'eglot-server-programs '(markdown-mode . ("marksman")))
  (add-hook 'markdown-mode-hook #'eglot-ensure)
)
#+END_SRC

* 1Password

I've been using 1Password while working on Pagerduty and it is awesome, this is how i integrate it:

#+BEGIN_SRC emacs-lisp
;; Enable auth-source
(after! auth-source

  ;; Setup 1Password as an auth-source backend
  (defun auth-source-op (host user port)
    (let ((secret (shell-command-to-string "op item get 'GitHubForge' --fields password --reveal")))
      (list (list :host host :user user :secret (lambda () (string-trim secret))))))

  (setq auth-sources '(auth-source-op "~/.authinfo.gpg")
        auth-source-do-cache t   ;; Cache results to avoid multiple lookups
        auth-source-debug t
        auth-source-cache-expiry 60) ;; Only 60 secs

  (auth-source-search :host "api.github.com" :user "afromankenobi^forge")
  )
#+END_SRC

* Mermaid Support

Install the mermaid-cli: ~npm install -g @mermaid-js/mermaid-cli~.

Then, add mermaid to org-babel config AND set mermaid-cli exec path:

#+BEGIN_SRC emacs-lisp
(after! ob
  ;; Configure available languages
  (org-babel-do-load-languages
   'org-babel-load-languages
   '((shell      . t)
     (js         . t)
     (emacs-lisp . t)
     (elixir     . t)
     (python     . t)
     (ruby       . t)
     (css        . t)
     (R          . t)
     (sql        . t)
     (sqlite     . t)
     (org        . t)
     (sed        . t)
     (csharp     . t)
     (mermaid    . t)
     (java       . t)))

  ;; Interpreter settings
  (setq org-babel-python-command "python3 -u"
        org-confirm-babel-evaluate nil
        ob-mermaid-cli-path "/Users/jvargas/.npm-global/bin/mmdc"))
#+END_SRC

* Configs for autocompletion:

I use ~corfu~ and i need to add the ~cape-dict~ to the ~completion-at-point-functions~.

#+BEGIN_SRC emacs-lisp

;; Configure dictionary completion with Corfu
(after! corfu
  (setq corfu-auto t) ;; Enable auto completion
  (setq corfu-preview-current t)

  ;; Enable dictionary completion with Cape
  (use-package! cape
    :after corfu
    :config
    ;; Add cape-dict to completion-at-point-functions
    (add-to-list 'completion-at-point-functions #'cape-dict)

    ;; Set dictionary file path (adjust if needed)
    (setq cape-dict-file "/usr/share/dict/words") ;; Change your dictionary path here depending on your OS

    ;; Add dictionary completion to specific text modes
    (add-hook! '(text-mode-hook
                 markdown-mode-hook
                 org-mode-hook)
               (lambda ()
                 (setq-local completion-at-point-functions
                             (list (cape-capf-super
                                    #'cape-dict
                                    #'cape-dabbrev)))))

    ;; Optional: Configure how completions are displayed
    (setq cape-dict-case-fold t)  ;; Ignore case when completing
    (setq cape-dict-aggressive nil))) ;; Don't be too aggressive with completions

;; Improve spell checking configuration
(after! ispell
  ;; Set your preferred dictionary
  (setq ispell-dictionary "en_US")

  ;; Make sure suggestions appear when you check a word
  (setq ispell-silently-savep t
        ispell-following-word nil
        ispell-highlight-face 'flyspell-incorrect))
#+END_SRC

* Previews

#+BEGIN_SRC emacs-lisp
;; Configure preview for search results
(after! consult
  ;; Enable automatic preview
  (consult-customize
   consult-ripgrep consult-git-grep consult-grep
   consult-bookmark consult-recent-file consult-xref
   +default/search-project +default/search-other-project
   +default/search-buffer +default/search-project-for-symbol-at-point
   +default/search-cwd +default/search-other-cwd
   +default/search-notes-for-symbol-at-point
   +default/search-emacsd
   ;; Set to show the preview at point
   :preview-key '(:debounce 0.1 any))

  ;; Configure preview display
  (setq consult-preview-key 'any       ;; Show preview on any key
        consult-preview-max-count 10   ;; Preview up to 10 candidates
        consult-preview-max-size 2048  ;; Preview files up to 2MB
        consult-narrow-key "<"         ;; Narrow results with
        consult-ripgrep-command "rg --null --line-buffered --max-columns=1000 --path-separator / --smart-case --no-heading --with-filename --line-number --search-zip"))

  ;; Use the most appropriate action by file type
  (setq consult-project-root-function #'projectile-project-root
        ;; Customize the narrowing keys for different categories
        consult-narrow-key "<"
        consult-widen-key ">"
        ;; Show line numbers in preview
        consult-line-numbers-widen t)

;; Improve the appearance of preview
(after! embark
  (setq embark-action-indicator
        (lambda (map _target)
          (which-key--show-keymap "Embark" map nil nil 'no-paging)
          #'which-key--hide-popup-ignore-command)
        embark-become-indicator embark-action-indicator))

#+END_SRC

* Kind icons

I discovered this and love it!

#+BEGIN_SRC emacs-lisp
(after! corfu
  (use-package! kind-icon
    :after corfu
    :config
    ;; Enable kind-icon in corfu
    (add-to-list 'corfu-margin-formatters #'kind-icon-margin-formatter)))
#+END_SRC

* Neotree

#+begin_src emacs-lisp
(use-package! neotree
  :config
  (setq neo-theme (if (display-graphic-p) 'icons 'arrow)))
#+end_src

* Claude code (!!!)

#+begin_src emacs-lisp
(after! claude-code-ide
  ; :bind (map :leader
  ;            (:prefix ("c" . "code")
  ;             :desc "Open claude-code" "C" #'claude-code-ide-menu)
  ;            )
  :config
  (claude-code-ide-emacs-tools-setup)) ; Optionally enable Emacs MCP tools
#+end_src

* GPTel

#+begin_src emacs-lisp
(use-package! gptel
 :config
 (setq! gptel-api-key (getenv "OPENAI_API_KEY"))
 (gptel-make-ollama "Ollama"
             :host "localhost:11434"
             :stream t
             :models '(DeepSeek-R1:latest))
 (gptel-make-gemini "Gemini" :key (getenv "GEMINI_API_KEY") :stream t)
 (gptel-make-kagi "Kagi" :key (getenv "KAGI_API_TOKEN"))
 (gptel-make-anthropic "Claude" :stream t :key (getenv "CLAUDE_API_TOKEN"))
 (gptel-make-anthropic "Claude-thinking"
  :key (getenv "CLAUDE_API_TOKEN")
  :stream t
  :models '(claude-opus-4-1-sonnet-20250805 claude-sonnet-4-20250514 claude-3-7-sonnet-20250219)
  :request-params '(:thinking (:type "enabled")))
 (gptel-make-gh-copilot "Copilot"))
#+end_src

* Org-reveal

#+begin_src emacs-lisp
(after! org
  (load-library "ox-reveal"))
#+end_src

* direnv integration

#+begin_src emacs-lisp
(use-package! envrc
  :hook (after-init . envrc-global-mode)  ; or just for prog-mode if you prefer
  :config
  (envrc-global-mode))
#+end_src

#+RESULTS:
| doom-init-fonts-h | doom-init-theme-h | envrc-global-mode | org-persist-load-all | ns-auto-titlebar-set-all-frames | tramp-register-archive-autoload-file-name-handler | magit-maybe-define-global-key-bindings | table--make-cell-map |
